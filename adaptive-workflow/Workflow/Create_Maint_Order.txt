import json
import pymssql
import logging
import os
from datetime import datetime

# Configure logging
logger = logging.getLogger()
logger.setLevel(logging.INFO)

# Fetch environment variables
DB_HOST = os.environ.get("DB_HOST")
DB_USER = os.environ.get("DB_USER")
DB_PASSWORD = os.environ.get("DB_PASSWORD")
DB_NAME = os.environ.get("DB_NAME")

def lambda_handler(event, context):
    try:
        logger.info(f"Received event: {json.dumps(event)}")

        machine_id = event.get('MachineId')
        approved = event.get('approved', True)

        if not approved:
            logger.warning("Approval not granted.")
            return {"status": "Approval not granted"}

        # Connect to SQL Server RDS
        conn = pymssql.connect(server=DB_HOST, user=DB_USER, password=DB_PASSWORD, database=DB_NAME)
        cursor = conn.cursor()

        # Generate OrderID
        order_id = f"MO_{int(datetime.now().timestamp())}"

        # Insert maintenance order
        insert_query = """
        INSERT INTO MaintenanceOrders (OrderID, MachineID, Status, CreatedAt)
        VALUES (%s, %s, %s, %s)
        """
        cursor.execute(insert_query, (order_id, machine_id, 'Created', datetime.now()))
        conn.commit()

        logger.info(f"Maintenance order created: {order_id}")

        return {
            "status": "Maintenance order created",
            "OrderID": order_id,
            "MachineID": machine_id
        }

    except pymssql.DatabaseError as e:
        logger.error(f"Database error: {str(e)}")
        return {"status": "error", "message": f"Database error: {str(e)}"}

    except Exception as e:
        logger.error(f"Unexpected error: {str(e)}")
        return {"status": "error", "message": f"Unexpected error: {str(e)}"}

    finally:
        try:
            cursor.close()
            conn.close()
        except:
            logger.warning("Failed to close DB connection properly.")
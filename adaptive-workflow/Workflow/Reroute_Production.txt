import json
import pymssql
import os
import logging

logger = logging.getLogger()
logger.setLevel(logging.INFO)

DB_HOST = os.environ.get("DB_HOST")
DB_USER = os.environ.get("DB_USER")
DB_PASSWORD = os.environ.get("DB_PASSWORD")
DB_NAME = os.environ.get("DB_NAME")

def lambda_handler(event, context):
    try:
        logger.info(f"Received event: {json.dumps(event)}")

        # Extract details from Step Function input
        machine_id = event.get("MachineID")
        new_route = event.get("NewRoute")

        if not machine_id or not new_route:
            return {"status": "error", "message": "MachineID and NewRoute are required"}

        # Connect to SQL Server
        conn = pymssql.connect(server=DB_HOST, user=DB_USER, password=DB_PASSWORD, database=DB_NAME)
        cursor = conn.cursor()

        # Insert routing info
        query = """
        INSERT INTO MES_Routing (MachineID, CurrentRoute)
        VALUES (%s, %s)
        """
        cursor.execute(query, (machine_id, new_route))
        conn.commit()

        response = {
            "status": "success",
            "message": f"Machine {machine_id} rerouted to {new_route}"
        }
        logger.info(f"Response: {response}")
        return response

    except Exception as e:
        logger.error(f"Error: {str(e)}")
        return {"status": "error", "message": str(e)}

    finally:
        try:
            cursor.close()
            conn.close()
        except:
            logger.warning("Failed to close DB connection.")